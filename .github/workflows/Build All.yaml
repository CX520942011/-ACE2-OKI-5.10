# .github/workflows/ä¸€é”®æ„å»ºæ‰€æœ‰ç‰ˆæœ¬.yml
name: ğŸš€ ä¸€é”®æ„å»ºæ‰€æœ‰å†…æ ¸ç‰ˆæœ¬

on:
  workflow_dispatch

env:
  TZ: Asia/Shanghai

jobs:
  trigger-builds:
    name: ğŸ¯ è§¦å‘å››ä¸ªå†…æ ¸æ„å»º
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“‹ æ˜¾ç¤ºæ„å»ºä¿¡æ¯
        run: |
          echo "ğŸš€ å¼€å§‹è§¦å‘æ‰€æœ‰å››ä¸ªå†…æ ¸æ„å»º"
          echo "========================================"
          echo "1. KSUN.yml - KernelSU"
          echo "2. KernelSU_SUSFS.yaml" 
          echo "3. MKSU_SUSFS.yaml"
          echo "4. SUKISU.yml"
          echo "========================================"
          echo "âš™ï¸ æ‰€æœ‰ç‰ˆæœ¬å‡åŒ…å«: SUSFS + LSM"
          echo "â±ï¸ é¢„è®¡æ„å»ºæ—¶é—´: 45-60åˆ†é’Ÿ"
          echo "ğŸ“¦ æ€»å…±4ä¸ªä¸åŒåˆ†æ”¯çš„å†…æ ¸ç‰ˆæœ¬"

      - name: ğŸš€ è§¦å‘ KSUN.yml
        uses: actions/github-script@v6
        with:
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'KSUN.yml',
              ref: 'main',
            })
            console.log('âœ… å·²è§¦å‘ KSUN.yml')

      - name: ğŸš€ è§¦å‘ KernelSU_SUSFS.yaml
        uses: actions/github-script@v6
        with:
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'KernelSU_SUSFS.yaml',
              ref: 'main',
            })
            console.log('âœ… å·²è§¦å‘ KernelSU_SUSFS.yaml')

      - name: ğŸš€ è§¦å‘ MKSU_SUSFS.yaml
        uses: actions/github-script@v6
        with:
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'MKSU_SUSFS.yaml',
              ref: 'main',
            })
            console.log('âœ… å·²è§¦å‘ MKSU_SUSFS.yaml')

      - name: ğŸš€ è§¦å‘ SUKISU.yml
        uses: actions/github-script@v6
        with:
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'SUKISU.yml',
              ref: 'main',
            })
            console.log('âœ… å·²è§¦å‘ SUKISU.yml')

      - name: â³ ç­‰å¾…æ„å»ºå¼€å§‹
        run: |
          echo "ğŸ¯ æ‰€æœ‰å››ä¸ªæ„å»ºä»»åŠ¡å·²è§¦å‘"
          echo "ğŸ”¨ æ„å»ºè¿›è¡Œä¸­ï¼Œè¯·ç­‰å¾…60åˆ†é’Ÿ..."

  wait-for-builds:
    name: â³ ç­‰å¾…æ„å»ºå®Œæˆ
    runs-on: ubuntu-latest
    needs: trigger-builds
    steps:
      - name: â° ç­‰å¾…60åˆ†é’Ÿ
        run: |
          echo "â±ï¸ ç­‰å¾…æ‰€æœ‰å†…æ ¸æ„å»ºå®Œæˆ..."
          echo "é¢„è®¡éœ€è¦60åˆ†é’Ÿï¼Œè¯·è€å¿ƒç­‰å¾…"
          for i in {1..12}; do
            echo "å·²ç­‰å¾… $((i*5)) åˆ†é’Ÿ..."
            sleep 300  # 5åˆ†é’Ÿ
          done
          echo "âœ… 60åˆ†é’Ÿç­‰å¾…å®Œæˆ"

  create-release:
    name: ğŸ‰ åˆ›å»ºä¸­æ–‡Release
    runs-on: ubuntu-latest
    needs: wait-for-builds
    steps:
      - name: ğŸ“… è·å–æ„å»ºä¿¡æ¯
        id: build_info
        run: |
          BUILD_TIME=$(TZ='Asia/Shanghai' date '+%Yå¹´%mæœˆ%dæ—¥ %H:%M:%S')
          DAY_OF_WEEK=$(TZ='Asia/Shanghai' date '+%u')
          case $DAY_OF_WEEK in
            "1") WEEKDAY="æ˜ŸæœŸä¸€" ;;
            "2") WEEKDAY="æ˜ŸæœŸäºŒ" ;;
            "3") WEEKDAY="æ˜ŸæœŸä¸‰" ;;
            "4") WEEKDAY="æ˜ŸæœŸå››" ;;
            "5") WEEKDAY="æ˜ŸæœŸäº”" ;;
            "6") WEEKDAY="æ˜ŸæœŸå…­" ;;
            "7") WEEKDAY="æ˜ŸæœŸæ—¥" ;;
          esac
          echo "build_time=$BUILD_TIME" >> $GITHUB_OUTPUT
          echo "weekday=$WEEKDAY" >> $GITHUB_OUTPUT

      - name: ğŸ·ï¸ åˆ›å»ºä¸­æ–‡Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: å…¨ç‰ˆæœ¬æ„å»º-${{ github.run_number }}
          name: "ğŸ¯ ä¸€åŠ  Ace 2 KSUå†…æ ¸ - ${{ steps.build_info.outputs.weekday }}"
          body: |
            # ğŸš€ ä¸€åŠ  Ace 2 

            ## ğŸ“… æ„å»ºä¿¡æ¯
            - **æ„å»ºç¼–å·**: #${{ github.run_number }}
            - **æ„å»ºæ—¶é—´**: ${{ steps.build_info.outputs.build_time }}
            - **åŒ…å«ç‰ˆæœ¬**: 4ä¸ªKernelSUåˆ†æ”¯
            - **æ„å»ºçŠ¶æ€**: âœ… è‡ªåŠ¨æ„å»ºå®Œæˆ

            ## âš™ï¸ ç»Ÿä¸€é…ç½®
            - âœ… **SUSFSæ”¯æŒ** - ç”¨æˆ·ç©ºé—´æ–‡ä»¶ç³»ç»Ÿ
            - âœ… **LSMä¿æŠ¤** - å†…æ ¸çº§å®‰å…¨ä¿æŠ¤
            - âœ… **KernelSU** - å†…æ ¸çº§Rootæ–¹æ¡ˆ
            - âœ… **BBRåŠ é€Ÿ** - ç½‘ç»œæ€§èƒ½ä¼˜åŒ–
            - âœ… **åŸºå¸¦ä¿æŠ¤** - é€šä¿¡æ¨¡å—å®‰å…¨

            ## ğŸ”§ åˆ·æœºæŒ‡å—
            1. ğŸ”‹ ç¡®ä¿ç”µé‡ > 50%
            2. ğŸ’¾ å¤‡ä»½BOOT
            3. ğŸ”“ ä½¿ç”¨SukiSUç®¡ç†å™¨æˆ–è€…ä½¿ç”¨Horizon Kernel Flasher[https://github.com/libxzr/HorizonKernelFlasher/releases/tag/v1.3]
            4. ğŸ“¦ é€‰æ‹©å¹¶åˆ·å…¥å¯¹åº”ç‰ˆæœ¬
            5. ğŸ”„ é‡å¯è®¾å¤‡

            ## âš ï¸ æ³¨æ„äº‹é¡¹
            - åˆ·æœºå‰è¯·åŠ¡å¿…å¤‡ä»½æ•°æ®
            - å»ºè®®åœ¨ä¸“ä¸šäººå£«æŒ‡å¯¼ä¸‹æ“ä½œ
            - å¦‚æœ‰é—®é¢˜è¯·æäº¤Issueåé¦ˆ
            
            ---
            *è‡ªåŠ¨åŒ–æ„å»ºäº ${{ steps.build_info.outputs.weekday }} ${{ steps.build_info.outputs.build_time }}*

          draft: false
          prerelease: false

      - name: âœ… æ„å»ºå®Œæˆé€šçŸ¥
        run: |
          echo "ğŸ‰ ä¸€é”®æ„å»ºæ‰€æœ‰ç‰ˆæœ¬å®Œæˆï¼"
          echo "ğŸ“¦ 4ä¸ªå†…æ ¸ç‰ˆæœ¬å·²æ„å»ºå®Œæˆ"
          echo "â±ï¸ æ€»æ„å»ºæ—¶é—´: çº¦60åˆ†é’Ÿ"
          echo "ğŸ”— Release å·²åˆ›å»ºï¼ŒåŒ…å«æ‰€æœ‰ç‰ˆæœ¬è¯´æ˜"
